// Datasource and generator
datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Core entities
model User {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  wallet       String?    @unique
  displayName  String?
  trust        Float      @default(0)
  
  platformUsers PlatformUser[]
  payouts       Payout[]
  
  @@index([wallet])
  @@index([trust])
}

model PlatformUser {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  userId       String?
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  platform     String
  platformId   String
  displayName  String?
  avatarUrl    String?
  
  messages     Message[]
  scores       Score[]
  reactions    Reaction[]
  payouts      Payout[]
  
  @@unique([platform, platformId])
  @@index([userId])
  @@index([platform, platformId])
}

model Source {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  platform     String
  platformId   String
  name         String?
  description  String?
  isActive     Boolean    @default(true)
  projectId    String
  crawlConfig  Json?
  
  messages     Message[]
  checkpoints  IngestCheckpoint[]
  
  @@unique([platform, platformId])
  @@index([projectId, isActive])
  @@index([platform, isActive])
}

model Message {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  projectId    String
  sourceId     String
  source       Source     @relation(fields: [sourceId], references: [id])
  externalId   String
  authorId     String
  author       PlatformUser @relation(fields: [authorId], references: [id])
  content      String
  contentLang  String?
  isDeleted    Boolean    @default(false)
  
  scores       Score[]
  reactions    Reaction[]
  relationsFrom MessageRelation[] @relation("from")
  relationsTo   MessageRelation[] @relation("to")
  discordDetails DiscordMessageDetail?
  metricSnapshots MetricSnapshot[]
  
  @@unique([sourceId, externalId])
  @@index([authorId, createdAt])
  @@index([sourceId, createdAt])
  @@index([isDeleted, createdAt])
  @@index([projectId, createdAt])
}

model Reaction {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  
  kind         String
  weight       Float?     @default(1)
  
  messageId    String
  message      Message    @relation(fields: [messageId], references: [id])
  platformUserId String
  platformUser PlatformUser @relation(fields: [platformUserId], references: [id])
  
  @@unique([messageId, platformUserId, kind])
  @@index([messageId, kind])
  @@index([platformUserId, kind])
  @@index([messageId, platformUserId])
}

model Score {
  id             String     @id @default(cuid())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  kind           String
  value          Float
  messageId      String
  message        Message    @relation(fields: [messageId], references: [id])
  platformUserId String
  platformUser   PlatformUser @relation(fields: [platformUserId], references: [id])
  details        Json?
  
  @@index([messageId, kind])
  @@index([platformUserId, kind])
  @@index([messageId, platformUserId])
}

model MessageRelation {
  id       String       @id @default(cuid())
  kind     RelationKind
  fromId   String
  toId     String
  from     Message      @relation("from", fields: [fromId], references: [id])
  to       Message      @relation("to", fields: [toId], references: [id])
  
  @@index([fromId, kind])
  @@index([toId, kind])
  @@index([kind])
}

model DiscordMessageDetail {
  messageId     String   @id
  message       Message  @relation(fields: [messageId], references: [id])
  guildId       String?
  channelId     String?
  threadId      String?
  embeds        Json?
  attachments   Json?
  
  @@index([guildId])
  @@index([channelId])
  @@index([threadId])
}

model MetricSnapshot {
  id          String   @id @default(cuid())
  messageId   String
  message     Message  @relation(fields: [messageId], references: [id])
  capturedAt  DateTime @default(now())
  likeCount   Int?
  replyCount  Int?
  repostCount Int?
  quoteCount  Int?
  viewCount   Int?
  meta        Json?

  @@index([messageId, capturedAt])
}

model IngestCheckpoint {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  sourceId     String
  source       Source     @relation(fields: [sourceId], references: [id])
  
  lastMessageId String?
  lastTimestamp DateTime?
  cursor        String?
  status        String    @default("active")
  
  errorCount    Int       @default(0)
  lastError     String?
  lastErrorAt   DateTime?
  
  @@unique([sourceId])
  @@index([status, updatedAt])
}

// Event persistence for audit trail
model EventsRaw {
  id              String   @id @default(cuid())
  idempotencyKey  String   @unique
  projectId       String
  platform        String
  type            String
  ts              DateTime
  source          Json
  payload         Json
  createdAt       DateTime @default(now())

  @@index([projectId, platform])
  @@index([type, ts])
  @@index([projectId, ts])
}

// Admin users for the admin interface
model Admin {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  email        String     @unique
  name         String
  passwordHash String
  isActive     Boolean    @default(true)
  lastLoginAt  DateTime?
  
  campaigns    Campaign[]
  payouts      Payout[]
}

// Token reward campaigns
model Campaign {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  name              String
  description       String?
  tokenSymbol       String
  isNative          Boolean   @default(false)
  chainId           String?
  tokenAddress      String?

  // amounts: switch to Decimal(78,0) (big int, wei-like)
  totalRewardPool   Decimal   @db.Decimal(78, 0)
  maxRewardsPerUser Decimal?  @db.Decimal(78, 0)

  // scheduling
  startDate         DateTime?        // optional: set after funding
  endDate           DateTime?        // optional
  isActive          Boolean   @default(true)

  // funding/state
  isFunded          Boolean   @default(false)
  status            CampaignStatus @default(DRAFT)
  vaultAddress      String?
  fundingTxHash     String?

  // epochs config
  payoutIntervalSeconds Int        // replaces timeframe (e.g., 604800 for 1 week)
  epochRewardCap        Decimal    @db.Decimal(78, 0) // max distributed per epoch
  claimWindowSeconds    Int        // e.g., 604800 (7 days) after epoch end
  recycleUnclaimed      Boolean    @default(true)

  platforms         String[]
  createdById       String
  createdBy         Admin     @relation(fields: [createdById], references: [id])

  // relations
  payouts           Payout[]
  epochs            CampaignEpoch[]

  @@index([startDate, endDate])
  @@index([isActive])
  @@index([status])
  @@index([isFunded])
  @@index([platforms])
}

// Individual payouts to users
model Payout {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  payoutAt       DateTime?
  status         PayoutStatus @default(PENDING)

  periodStart    DateTime
  periodEnd      DateTime

  platformUserId String
  platformUser   PlatformUser @relation(fields: [platformUserId], references: [id])

  userId         String
  user           User         @relation(fields: [userId], references: [id])

  campaignId     String
  campaign       Campaign     @relation(fields: [campaignId], references: [id])

  // amounts: Decimal for on-chain integer
  amount         Decimal      @db.Decimal(78, 0)

  txHash         String?
  errorMessage   String?
  processedById  String?
  processedBy    Admin?       @relation(fields: [processedById], references: [id])

  // NEW: link to epoch (nullable for historical rows)
  epochId        String?
  epoch          CampaignEpoch? @relation(fields: [epochId], references: [id], onDelete: SetNull)

  @@index([userId, campaignId])
  @@index([status])
  @@index([createdAt])
  @@index([periodStart, periodEnd])
  @@index([platformUserId, campaignId])
  @@index([epochId])
}

// Campaign epochs for recurring payouts
model CampaignEpoch {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  campaignId       String
  campaign         Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  epochNumber      Int       // 1,2,3,...
  epochStart       DateTime
  epochEnd         DateTime               // = epochStart + payoutIntervalSeconds
  claimWindowEnds  DateTime               // = epochEnd + claimWindowSeconds

  allocated        Decimal   @db.Decimal(78, 0)  // typically = epochRewardCap or remaining pool
  claimed          Decimal   @db.Decimal(78, 0) @default(0)
  recycledAt       DateTime?
  state            EpochState @default(OPEN)     // OPEN|CLAIMING|RECYCLED|EXPIRED|CLOSED

  payouts          Payout[]

  @@unique([campaignId, epochNumber])
  @@index([campaignId, state])
  @@index([epochStart, epochEnd, claimWindowEnds])
}

// System configuration and settings
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  
  @@index([key])
}

// Enums
enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RelationKind {
  REPLY_TO
  QUOTE_OF
  RETWEET_OF
  REPOST_OF
  THREAD_PARENT
  MENTIONS
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELED
}

enum EpochState {
  OPEN        // accrual/earning period
  CLAIMING    // after epochEnd, within claim window
  RECYCLED    // unclaimed moved back
  EXPIRED     // claim window ended without recycle (if disabled)
  CLOSED      // finalized
}